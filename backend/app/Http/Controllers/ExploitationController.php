<?php

namespace App\Http\Controllers;

use App\Models\Exploitation;
use App\Http\Requests\StoreExploitationRequest;
use App\Http\Requests\UpdateExploitationRequest;
use App\Models\Produit_sante;
use Illuminate\Support\Facades\Gate;
use Illuminate\Http\Request;

class ExploitationController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index(Request $request)
    {
        //
        $donnee_exploitations = [];
        $exploitants = $request->user()->exploitant()->get();
        // $produits = [];
        foreach ($exploitants as $exploitant) {

            $exploitations =
                $exploitant->exploitation()->get();
            foreach ($exploitations as $exploitation) {
                $produit = Produit_sante::where("id", $exploitation->produit_sante_id)->first();

                array_push($donnee_exploitations, ["produit" => $produit, "exploitant" => $exploitant, "exploitation" => $exploitation]);
            }

            // $request->user()->exploitation()->create($produit_sante_exploite);
        }
        // Gate::authorize("viewAny", $request->user());
        // return Exploitation::all();
        return $donnee_exploitations;
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        //
        //
        //  Gate::authorize("create", [$request->user()]);
        //



        // $fields=$request->validate([
        //     // "produit_sante_id"=> 'required',
        //     // "type_exploitation"=> 'required',
        //     'produits_sante_exploites'=> 'required|array',
        //     'produits_sante_exploites.*.produit_sante_id'=> 'required',
        //     'produits_sante_exploites.*.type_exploitation'=> 'required',

        // ]);

        $fields = $request->validate([
            "exploitant_id" => 'required',
            // "produit_sante_id" => 'required',
            // "exploitant_id" => 'required',
            'produits_sante_exploites' => 'required|array',
            'produits_sante_exploites.*.produit_sante_id' => 'required',
            'produits_sante_exploites.*.type_exploitation' => 'required',

        ]);

        $prv_exploitant = $request->user()->exploitant()
            ->where('id', $fields["exploitant_id"])
            ->first();

        foreach ($fields["produits_sante_exploites"] as $produit) {
            // $aggregation->infos=
            $prv_exploitant->exploitation()->create($produit);
        }


        return [
            'message' => "Demande d'exploitation enregistrÃ©e ",
        ];
        // $notification=$request->user()->exploitation()->create($fields);
    }

    /**
     * Display the specified resource.
     */
    public function show(Exploitation $exploitation)
    {
        //
        // Gate::authorize("view", $exploitation);
        return $exploitation;
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, Exploitation $exploitation)
    {
        //
        // Gate::authorize("update", $exploitation);
        $fields = $request->validate([
            'produit_sante_id' => 'required',
            'type_exploitation' => 'required',

        ]);

        $exploitation->update($fields);

        return $exploitation;
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(Exploitation $exploitation)
    {
        //
        // Gate::authorize("delete", $exploitation);
        $exploitation->delete();
    }
}
